<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Musoucrow' BLOG" />





  <link rel="alternate" href="/atom.xml" title="Musoucrow' BLOG" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="Musoucrow' BLOG">
<meta property="og:url" content="https://musoucrow.github.io/page/5/index.html">
<meta property="og:site_name" content="Musoucrow' BLOG">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Musoucrow' BLOG">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://musoucrow.github.io/page/5/"/>





  <title> Musoucrow' BLOG </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Musoucrow' BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://musoucrow.github.io/2017/12/07/dfq_building/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Musoucrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Musoucrow' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/07/dfq_building/" itemprop="url">
                  游戏测试同步于Android设备的解决方案
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-12-07T05:33:42+08:00">
                2017-12-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Teach/" itemprop="url" rel="index">
                    <span itemprop="name">Teach</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/07/dfq_building/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/12/07/dfq_building/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/12/07/dfq_building/" class="leancloud_visitors" data-flag-title="游戏测试同步于Android设备的解决方案">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　<strong>欢迎参与讨论，转载请注明出处。</strong></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>　　最近开发中的游戏需要在Android手机上进行测试，但采用USB数据线连接主机进行文件替换的更新实在是太麻烦了。遂考虑整个远程更新的解决方案，在研究的过程中排除了开发APP（耗费时长）与内置热更新（LuaSocket遇到点问题），最终选择了现在的在手机上安装Git客户端的方案。</p>
<h2 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h2><p>　　首先我选用了<a href="https://hsojo.github.io/assets/AndroidGit/com.aor.pocketgit.apk" target="_blank" rel="external">PocketGit</a>作为Android的Git客户端，它可以满足我的基本需求。（感谢<a href="https://hsojo.github.io/2017/12/05/AndroidGit/" target="_blank" rel="external">Hs</a>的提供）但是仅仅如此是不够的，事实上不可能直接使用工程所用的Git仓库作为测试使用，毕竟测试的提交是十分频繁的。于是我首先考虑到了在工程仓库上创建测试分支，但是这也不够舒适，因为各分支的文件情况是独立的，到了特定时刻还得考虑合并的事。且测试分支的提交也会影响节点视图的观赏性，所以我选择了专门开一个测试仓库，通过编写Python脚本以一键同步相关文件并commit，十分方便。</p>
<h2 id="脚本的实现"><a href="#脚本的实现" class="headerlink" title="脚本的实现"></a>脚本的实现</h2><p>　　以下为程序源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> shutil</div><div class="line"><span class="keyword">import</span> zipfile</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sync</span><span class="params">(path_a, path_b)</span>:</span></div><div class="line">    is_file_a = os.path.isfile(path_a)</div><div class="line">    is_file_b = os.path.isfile(path_b)</div><div class="line">    is_dir_a = os.path.isdir(path_a)</div><div class="line">    is_dir_b = os.path.isdir(path_b)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> is_file_a:</div><div class="line">        <span class="keyword">if</span> is_dir_b:</div><div class="line">            shutil.rmtree(path_b, <span class="keyword">True</span>)</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> is_file_b:</div><div class="line">            time_a = os.stat(path_a).st_mtime</div><div class="line">            time_b = os.stat(path_b).st_mtime</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> time_a != time_b:</div><div class="line">                shutil.copy2(path_a, path_b)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            shutil.copy2(path_a, path_b)</div><div class="line">    <span class="keyword">elif</span> is_dir_a:</div><div class="line">        <span class="keyword">if</span> is_file_b:</div><div class="line">            os.remove(path_b)</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> is_dir_b:</div><div class="line">            list_a = os.listdir(path_a)</div><div class="line">            list_b = os.listdir(path_b)</div><div class="line">            list_merger = list(set(list_a + list_b))</div><div class="line"></div><div class="line">            <span class="keyword">for</span> path <span class="keyword">in</span> list_merger:</div><div class="line">                sync(path_a + <span class="string">"/"</span> + path, path_b + <span class="string">"/"</span> + path)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            shutil.copytree(path_a, path_b)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">if</span> is_dir_b:</div><div class="line">            shutil.rmtree(path_b, <span class="keyword">True</span>)</div><div class="line">        <span class="keyword">elif</span> is_file_b:</div><div class="line">            os.remove(path_b)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_archive</span><span class="params">(path)</span>:</span></div><div class="line">    zip_file = zipfile.ZipFile(path, <span class="string">"w"</span>)</div><div class="line">    zip_file.write(<span class="string">"conf.lua"</span>)</div><div class="line">    zip_file.write(<span class="string">"main.lua"</span>)</div><div class="line">    zip_file.write(<span class="string">"path.lua"</span>)</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(<span class="string">"asset/font"</span>):</div><div class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> files:</div><div class="line">            zip_file.write(root + <span class="string">"/"</span> + f)</div><div class="line">    </div><div class="line">    zip_file.close()</div><div class="line"></div><div class="line">sync(<span class="string">"asset"</span>, <span class="string">"build/asset"</span>)</div><div class="line">sync(<span class="string">"config"</span>, <span class="string">"build/config"</span>)</div><div class="line">sync(<span class="string">"source"</span>, <span class="string">"build/source"</span>)</div><div class="line">make_archive(<span class="string">"build/game.love"</span>)</div><div class="line"></div><div class="line">now_time = time.strftime(<span class="string">"%Y-%m-%d-%H:%M:%S"</span>, time.localtime(time.time()))</div><div class="line">os.system(</div><div class="line">    <span class="string">"""</span></div><div class="line">    cd build</div><div class="line">    git add .</div><div class="line">    git commit -m %s</div><div class="line">    """ % now_time</div><div class="line">)</div></pre></td></tr></table></figure>
<p>　　脚本的实现思路为将工程仓库下的三个文件夹与对应的测试仓库里的文件夹做对比，若工程仓库存在文件而测试仓库不存在，则复制之。若存在，则对比两者的最后修改日期，不一致则复制。（这里原本是考虑使用MD5检测文件完整性的，不过这将会影响到效率，发现在<strong>合理使用的前提下</strong>，只检测最后修改日期也无妨，遂采用）若出现测试仓库存在而工程仓库不存在的文件/文件夹，则删除之。<br>　　然后便是对某些关键文件进行打包为.love文件存放到测试仓库，它是<a href="https://love2d.org" target="_blank" rel="external">LÖVE</a>的可执行文件，但实际上只是个.zip文件。最后便是对测试仓库进行commit。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>　　<img src="https://musoucrow.github.io/images/dfq_building/config.png" alt="config">然后如这般做好配置，便可在Android设备上克隆主机的测试仓库了（以局域网的形式）。<img src="https://musoucrow.github.io/images/dfq_building/ssh.png" alt="config">当然还得确保主机开启了ssh，在macOS下开启ssh的方式为：System Preferences → Sharing → Remote Login。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://musoucrow.github.io/2017/10/13/about_strtok/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Musoucrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Musoucrow' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/13/about_strtok/" itemprop="url">
                  关于C语言函数strtok引发的思考
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-13T16:03:33+08:00">
                2017-10-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Teach/" itemprop="url" rel="index">
                    <span itemprop="name">Teach</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/13/about_strtok/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/13/about_strtok/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/10/13/about_strtok/" class="leancloud_visitors" data-flag-title="关于C语言函数strtok引发的思考">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　<strong>欢迎参与讨论，转载请注明出处。</strong></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>　　近期遇到个C语言的课题作业，要求完成parse功能（以空格、回车、TAB为分割符分割字符串，输出结果且返回数组。）该功能涉及到strtok函数的一些问题，特此开贴记录。</p>
<h2 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h2><p>　　以下为程序源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">struct</span> ListNode &#123;</div><div class="line">	<span class="keyword">char</span> * value;</div><div class="line">	<span class="keyword">struct</span> ListNode * next;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span> ** <span class="title">parse</span><span class="params">(<span class="keyword">char</span> * line)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (line == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> delim[] = <span class="string">" \t\n"</span>; <span class="comment">/* SPACE or TAB or NL */</span></div><div class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">    <span class="keyword">char</span> * token;</div><div class="line">    <span class="keyword">char</span> ** newArgv;</div><div class="line">    <span class="keyword">char</span> str[<span class="built_in">strlen</span>(line)];</div><div class="line">    </div><div class="line">    <span class="built_in">strcpy</span>(str, line);</div><div class="line">    token = strtok(str, delim);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (token == <span class="literal">NULL</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">struct</span> ListNode * head = (<span class="keyword">struct</span> ListNode *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> ListNode));</div><div class="line">    <span class="keyword">struct</span> ListNode * cur = head;</div><div class="line">    cur-&gt;value = token;</div><div class="line">    count ++;</div><div class="line">    </div><div class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">        token = strtok(<span class="literal">NULL</span>, delim);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (token == <span class="literal">NULL</span>) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        cur-&gt;next = (<span class="keyword">struct</span> ListNode *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> ListNode));</div><div class="line">        cur = cur-&gt;next;</div><div class="line">        cur-&gt;value = token;</div><div class="line">        count ++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    newArgv = (<span class="keyword">char</span> **)<span class="built_in">malloc</span>((count + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">char</span> *));</div><div class="line">    cur = head;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        newArgv[i] = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(cur-&gt;value) * <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</div><div class="line">        <span class="built_in">strcpy</span>(newArgv[i], cur-&gt;value);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"[%d] : %s\n"</span>, i, cur-&gt;value);</div><div class="line">        <span class="built_in">free</span>(cur);</div><div class="line">        cur = cur-&gt;next;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    newArgv[count] = <span class="literal">NULL</span>; <span class="comment">//tail</span></div><div class="line">    </div><div class="line">    <span class="keyword">return</span> newArgv;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">char</span> ** argv = parse(<span class="string">"system program"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="第一个问题"><a href="#第一个问题" class="headerlink" title="第一个问题"></a>第一个问题</h3><p>　　首先第一个问题便是这里：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> str[<span class="built_in">strlen</span>(line)];</div><div class="line"></div><div class="line"><span class="built_in">strcpy</span>(str, line);</div><div class="line">token = strtok(str, delim);</div></pre></td></tr></table></figure>
<p>　　最初尝试直接把parse函数的参数line直接作为strtok函数的第一参数填入，结果不行。查阅文档后发现strtok的声明为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//param: str -- 要被分解成一组小字符串的字符串。</span></div><div class="line"><span class="comment">//param: delim -- 包含分隔符的 C 字符串。</span></div><div class="line"><span class="comment">//return: 该函数返回被分解的最后一个子字符串，如果没有可检索的字符串，则返回一个空指针。</span></div><div class="line"><span class="function"><span class="keyword">char</span> *<span class="title">strtok</span><span class="params">(<span class="keyword">char</span> * str, <span class="keyword">const</span> <span class="keyword">char</span> * delim)</span></span>;</div></pre></td></tr></table></figure>
<p>　　可以发现，第一参数char * str要求的并非const，而我在调用时填入的参数为‘system program’，这种字符串数据是作为‘const char[]’保存在字符串常量区的，故不符合参数需求。需要重新申请一片栈空间复制line的内容再作为参数填入。</p>
<h3 id="第二个问题"><a href="#第二个问题" class="headerlink" title="第二个问题"></a>第二个问题</h3><p>　　由此衍生的第二个问题便是：为何要为newArgv[i]申请新的空间，而非<code>newArgv[i] = cur-&gt;value;</code>？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">newArgv[i] = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(cur-&gt;value) * <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</div><div class="line"><span class="built_in">strcpy</span>(newArgv[i], cur-&gt;value);</div></pre></td></tr></table></figure>
<p>　　这一点的原因主要是 <strong>strtok返回的字符串其实并非新的副本，而是从str上截取的一部分而已。</strong> 而cur-&gt;value便是来自于str，且str是拥有生命周期的栈数据，而如果将这样的部分保存在newArgv后返回到外部，便会因为生命周期问题，导致数据被回收。这将会产生很可怕的后果。所以必须申请新的空间，形成复制。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>　　没有垃圾回收的C/C++，编程时必须对内存的分配和流向必须要有十分清晰的认识，不然就很容易发生内存泄漏和野指针现象。慎之、慎之。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://musoucrow.github.io/2017/08/26/frame_sync/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Musoucrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Musoucrow' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/26/frame_sync/" itemprop="url">
                  帧同步的初步探究
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-26T17:30:16+08:00">
                2017-08-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/" itemprop="url" rel="index">
                    <span itemprop="name">Network</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/08/26/frame_sync/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/08/26/frame_sync/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/08/26/frame_sync/" class="leancloud_visitors" data-flag-title="帧同步的初步探究">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　<strong>欢迎参与讨论，转载请注明出处。</strong></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>　　在阅读这篇文章之前，你需要了解一下何为<a href="http://www.skywind.me/blog/archives/131" target="_blank" rel="external">帧同步</a>。关于帧同步的实现尝试，其实近年来一直都有不间断的尝试，不过大多浅尝辄止，这次总算是一次较为完整的实现了。接下来便对这次实现介绍一二。</p>
<h2 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h2><p>　　本次项目使用的开发引擎为<a href="https://love2d.org" target="_blank" rel="external">LÖVE</a>，<a href="https://git.coding.net/musoucrow/FrameSync.git" target="_blank" rel="external">项目地址在此</a>。以下是运行演示（外网联机测试也通过了）：<img src="https://musoucrow.github.io/images/frame_sync/1.png" alt="1"><br>　　由于我并没有什么服务端开发的相关经验，所以只是使用了个简单的UDP网络库——<a href="http://enet.bespin.org/index.html" target="_blank" rel="external">ENet</a>。客户端与服务端共同处于一个项目下，非常的浅薄，以下是服务端与客户端的代码展示。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--server.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Enet = <span class="built_in">require</span> (<span class="string">"enet"</span>)</div><div class="line"><span class="keyword">local</span> Lib = <span class="built_in">require</span>(<span class="string">"lib"</span>)</div><div class="line"></div><div class="line"><span class="keyword">local</span> host = Enet.host_create(<span class="string">"localhost:6789"</span>)</div><div class="line"><span class="keyword">local</span> peerMap = &#123;&#125;</div><div class="line"><span class="keyword">local</span> dataMap = &#123;&#125;</div><div class="line"><span class="keyword">local</span> inputMap = &#123;&#125;</div><div class="line"><span class="keyword">local</span> playList = &#123;&#125;</div><div class="line"><span class="keyword">local</span> playFrame = <span class="number">0</span></div><div class="line"><span class="keyword">local</span> frame = <span class="number">0</span></div><div class="line"><span class="keyword">local</span> userCount = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="built_in">print</span>(<span class="string">"start"</span>)</div><div class="line"></div><div class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) <span class="keyword">do</span></div><div class="line">	<span class="keyword">local</span> event = host:service(<span class="number">17</span>)</div><div class="line">	</div><div class="line">	<span class="keyword">while</span> (event) <span class="keyword">do</span></div><div class="line">		<span class="keyword">local</span> <span class="built_in">type</span>, ip, data = Lib.Recv(event)</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (<span class="built_in">type</span> == <span class="string">"input"</span>) <span class="keyword">then</span></div><div class="line">			inputMap[ip] = data</div><div class="line">		<span class="keyword">elseif</span> (<span class="built_in">type</span> == <span class="string">"connect"</span>) <span class="keyword">then</span></div><div class="line">			event.peer:timeout(<span class="number">10</span>, <span class="number">3000</span>, <span class="number">5000</span>)</div><div class="line">			<span class="keyword">local</span> data = &#123;ip = ip, x = <span class="built_in">math</span>.random(<span class="number">0</span>, <span class="number">800</span>), y = <span class="built_in">math</span>.random(<span class="number">0</span>, <span class="number">600</span>)&#125;</div><div class="line">			</div><div class="line">			<span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(peerMap) <span class="keyword">do</span></div><div class="line">				Lib.Send(v, <span class="string">"addNewUser"</span>, data)</div><div class="line">			<span class="keyword">end</span></div><div class="line">			</div><div class="line">			peerMap[ip] = event.peer</div><div class="line">			dataMap[ip] = data</div><div class="line">			inputMap[ip] = &#123;&#125;</div><div class="line">			userCount = userCount + <span class="number">1</span></div><div class="line">			</div><div class="line">			Lib.Send(event.peer, <span class="string">"loginSuccess"</span>, &#123;ip = ip, users = dataMap, playList = playList&#125;)</div><div class="line">			</div><div class="line">			<span class="built_in">print</span>(<span class="string">"connect"</span>, ip)</div><div class="line">		<span class="keyword">elseif</span> (<span class="built_in">type</span> == <span class="string">"disconnect"</span>) <span class="keyword">then</span></div><div class="line">			peerMap[ip] = <span class="keyword">nil</span></div><div class="line">			dataMap[ip] = <span class="keyword">nil</span></div><div class="line">			inputMap[ip] = <span class="keyword">nil</span></div><div class="line">			userCount = userCount - <span class="number">1</span></div><div class="line">			</div><div class="line">			<span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(peerMap) <span class="keyword">do</span></div><div class="line">				Lib.Send(v, <span class="string">"delUser"</span>, ip)</div><div class="line">			<span class="keyword">end</span></div><div class="line">			</div><div class="line">			event.peer:disconnect(<span class="number">-1</span>)</div><div class="line">			<span class="built_in">print</span>(<span class="string">"disconnect"</span>, ip)</div><div class="line">		<span class="keyword">end</span></div><div class="line">		</div><div class="line">		event = host:service()</div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (userCount &gt; <span class="number">0</span>) <span class="keyword">then</span></div><div class="line">		frame = frame + <span class="number">1</span></div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (frame % <span class="number">3</span> == <span class="number">0</span>) <span class="keyword">then</span></div><div class="line">			playFrame = playFrame + <span class="number">1</span></div><div class="line">			<span class="built_in">print</span>(playFrame)</div><div class="line">			</div><div class="line">			<span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(peerMap) <span class="keyword">do</span></div><div class="line">				Lib.Send(v, <span class="string">"play"</span>, inputMap)</div><div class="line">			<span class="keyword">end</span></div><div class="line">			</div><div class="line">			playList[#playList + <span class="number">1</span>] = Lib.Clone(inputMap)</div><div class="line">		<span class="keyword">end</span></div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--main.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Actor = <span class="built_in">require</span>(<span class="string">"actor"</span>)</div><div class="line"><span class="keyword">local</span> Lib = <span class="built_in">require</span>(<span class="string">"lib"</span>)</div><div class="line"><span class="keyword">local</span> Enet = <span class="built_in">require</span> (<span class="string">"enet"</span>)</div><div class="line"></div><div class="line"><span class="keyword">local</span> userList = &#123;&#125;</div><div class="line"><span class="keyword">local</span> userMap = &#123;&#125;</div><div class="line"><span class="keyword">local</span> input = &#123;&#125;</div><div class="line"><span class="keyword">local</span> playList = &#123;&#125;</div><div class="line"><span class="keyword">local</span> playFrame = <span class="number">0</span></div><div class="line"><span class="keyword">local</span> perdt = <span class="number">17</span></div><div class="line"><span class="keyword">local</span> timer = <span class="number">0</span></div><div class="line"><span class="keyword">local</span> frame = <span class="number">0</span></div><div class="line"><span class="keyword">local</span> player</div><div class="line"><span class="keyword">local</span> fps = <span class="number">0</span></div><div class="line"><span class="keyword">local</span> timer2 = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> host = Enet.host_create()</div><div class="line"><span class="keyword">local</span> server = host:connect(<span class="string">"localhost:6789"</span>)</div><div class="line"></div><div class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">NewActor</span><span class="params">(x, y, ip)</span></span></div><div class="line">	<span class="keyword">local</span> actor = Actor.New(x, y, ip)</div><div class="line">	userMap[ip] = actor</div><div class="line">	userList[#userList + <span class="number">1</span>] = actor</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> actor</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">Update</span><span class="params">()</span></span></div><div class="line">	<span class="keyword">if</span> ((frame + <span class="number">1</span>) % <span class="number">3</span> == <span class="number">0</span> <span class="keyword">and</span> #playList == <span class="number">0</span>) <span class="keyword">then</span></div><div class="line">		<span class="keyword">return</span></div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	frame = frame + <span class="number">1</span></div><div class="line">	fps = fps + <span class="number">1</span></div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (frame % <span class="number">3</span> == <span class="number">0</span>) <span class="keyword">then</span></div><div class="line">		<span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(playList[<span class="number">1</span>]) <span class="keyword">do</span></div><div class="line">			<span class="keyword">if</span> (userMap[k]) <span class="keyword">then</span></div><div class="line">				userMap[k].input = v</div><div class="line">			<span class="keyword">end</span></div><div class="line">		<span class="keyword">end</span></div><div class="line">		</div><div class="line">		playFrame = playFrame + <span class="number">1</span></div><div class="line">		<span class="built_in">table</span>.remove(playList, <span class="number">1</span>)</div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="keyword">for</span> n=<span class="number">1</span>, #userList <span class="keyword">do</span></div><div class="line">		userList[n]:Update()</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">love.load</span><span class="params">()</span></span></div><div class="line">	<span class="keyword">local</span> event, <span class="built_in">type</span>, ip, data</div><div class="line">	</div><div class="line">	<span class="keyword">repeat</span></div><div class="line">		event = host:service()</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (event) <span class="keyword">then</span></div><div class="line">			<span class="built_in">type</span>, ip, data = Lib.Recv(event)</div><div class="line">		<span class="keyword">end</span></div><div class="line">	<span class="keyword">until</span> event ~= <span class="keyword">nil</span> <span class="keyword">and</span> <span class="built_in">type</span> == <span class="string">"loginSuccess"</span></div><div class="line"></div><div class="line">	<span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(data.users) <span class="keyword">do</span></div><div class="line">		<span class="keyword">local</span> actor = NewActor(v.x, v.y, v.ip)</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (v.ip == data.ip) <span class="keyword">then</span></div><div class="line">			player = actor</div><div class="line">			<span class="built_in">print</span>(<span class="string">"loginSuccess"</span>, v.ip)</div><div class="line">		<span class="keyword">end</span></div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	playList = data.playList</div><div class="line">	</div><div class="line">	<span class="keyword">while</span> (#playList &gt; <span class="number">0</span>) <span class="keyword">do</span></div><div class="line">		Update()</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">love.update</span><span class="params">(dt)</span></span></div><div class="line">	<span class="keyword">local</span> event = host:service()</div><div class="line">	</div><div class="line">	<span class="keyword">while</span> event <span class="keyword">do</span></div><div class="line">		<span class="keyword">local</span> <span class="built_in">type</span>, ip, data = Lib.Recv(event)</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (<span class="built_in">type</span> == <span class="string">"play"</span>) <span class="keyword">then</span></div><div class="line">			playList[#playList + <span class="number">1</span>] = data</div><div class="line">		<span class="keyword">elseif</span> (<span class="built_in">type</span> == <span class="string">"addNewUser"</span>) <span class="keyword">then</span></div><div class="line">			NewActor(data.x, data.y, data.ip)</div><div class="line">		<span class="keyword">elseif</span> (<span class="built_in">type</span> == <span class="string">"delUser"</span>) <span class="keyword">then</span></div><div class="line">			userMap[data] = <span class="keyword">nil</span></div><div class="line">			</div><div class="line">			<span class="keyword">for</span> n=#userList, <span class="number">1</span>, <span class="number">-1</span> <span class="keyword">do</span></div><div class="line">				<span class="keyword">if</span> (userList[n].ip == data) <span class="keyword">then</span></div><div class="line">					<span class="built_in">table</span>.remove(userList, n)</div><div class="line">				<span class="keyword">end</span></div><div class="line">			<span class="keyword">end</span></div><div class="line">		<span class="keyword">end</span></div><div class="line">		</div><div class="line">		event = host:service()</div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	dt = <span class="built_in">math</span>.floor(dt * <span class="number">1000</span>)</div><div class="line">	timer = timer + dt</div><div class="line">	</div><div class="line">	<span class="keyword">while</span> (timer &gt;= perdt) <span class="keyword">do</span></div><div class="line">		<span class="comment">--print(#playList)</span></div><div class="line">		<span class="keyword">if</span> ((frame + <span class="number">1</span>) % <span class="number">3</span> == <span class="number">0</span> <span class="keyword">and</span> #playList &gt; <span class="number">1</span>) <span class="keyword">then</span></div><div class="line">			<span class="keyword">while</span> (#playList &gt; <span class="number">0</span>) <span class="keyword">do</span></div><div class="line">				Update()</div><div class="line">			<span class="keyword">end</span></div><div class="line">		<span class="keyword">else</span></div><div class="line">			Update()</div><div class="line">		<span class="keyword">end</span></div><div class="line">		</div><div class="line">		timer = timer - perdt</div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	timer2 = timer2 + dt</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (timer2 &gt;= <span class="number">1000</span>) <span class="keyword">then</span></div><div class="line">		<span class="comment">--print(timer2, fps)</span></div><div class="line">		fps = <span class="number">0</span></div><div class="line">		timer2 = timer2 - <span class="number">1000</span></div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">love.draw</span><span class="params">()</span></span></div><div class="line">	<span class="keyword">for</span> n=<span class="number">1</span>, #userList <span class="keyword">do</span></div><div class="line">		userList[n]:Draw()</div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	love.graphics.<span class="built_in">print</span>(playFrame, <span class="number">5</span>, <span class="number">5</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">love.keypressed</span><span class="params">(key)</span></span></div><div class="line">	<span class="keyword">if</span> (key == <span class="string">"up"</span> <span class="keyword">or</span> key == <span class="string">"down"</span> <span class="keyword">or</span> key == <span class="string">"left"</span> <span class="keyword">or</span> key == <span class="string">"right"</span>) <span class="keyword">then</span></div><div class="line">		input[key] = <span class="number">1</span></div><div class="line">		Lib.Send(server, <span class="string">"input"</span>, input)</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">love.keyreleased</span><span class="params">(key)</span></span></div><div class="line">	<span class="keyword">if</span> (key == <span class="string">"up"</span> <span class="keyword">or</span> key == <span class="string">"down"</span> <span class="keyword">or</span> key == <span class="string">"left"</span> <span class="keyword">or</span> key == <span class="string">"right"</span>) <span class="keyword">then</span></div><div class="line">		input[key] = <span class="number">0</span></div><div class="line">		Lib.Send(server, <span class="string">"input"</span>, input)</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>　　从代码中可以看出，以上实现便是Skywind所说的<strong>乐观帧锁定</strong>。事实上我认为传统的帧同步（Lockstep）并不适合网络游戏，甚至只是一种早期的理论模型。在实际应用还是要以乐观帧锁定为准。关于乐观帧锁定的实现原理我便不再复述，只说说实际开发中遇到的一些问题。  </p>
<h3 id="Fixed-Update"><a href="#Fixed-Update" class="headerlink" title="Fixed Update"></a>Fixed Update</h3><p>　　很抱歉我找不到这个词对应的中文词汇，直译过来的意思便是“固定的更新”。在实际应用的含义为，每隔一段时间便会Update一次，如果遇到卡住之类导致积累了很长时间的行为，则会根据时间一次性进行多次Update。也就是这段代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--Fixed Update(main.lua)</span></div><div class="line"></div><div class="line">timer = timer + dt</div><div class="line"></div><div class="line"><span class="keyword">while</span> (timer &gt;= perdt) <span class="keyword">do</span></div><div class="line">    <span class="keyword">if</span> ((frame + <span class="number">1</span>) % <span class="number">3</span> == <span class="number">0</span> <span class="keyword">and</span> #playList &gt; <span class="number">1</span>) <span class="keyword">then</span></div><div class="line">        <span class="keyword">while</span> (#playList &gt; <span class="number">0</span>) <span class="keyword">do</span></div><div class="line">            Update()</div><div class="line">        <span class="keyword">end</span></div><div class="line">    <span class="keyword">else</span></div><div class="line">        Update()</div><div class="line">    <span class="keyword">end</span></div><div class="line">    </div><div class="line">    timer = timer - perdt</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>　　使用了Fixed Update后，你的游戏进度便由时间牢牢把控住，这样便能摆脱帧率的影响。在业务层也不再需要使用DT(Delta Time)了，而是采用一个固定的值（譬如1 / 60）。这个概念很重要，因为过快与过慢的帧率都会与同步不那么搭调。</p>
<h3 id="收发频率"><a href="#收发频率" class="headerlink" title="收发频率"></a>收发频率</h3><p>　　按照Skywind的说法是服务端每秒20-50次向所有客户端发送同步包。这里我们需要理清乐观帧锁定的本质：<strong>就是服务端每隔一段时间发送同步包，然后客户端每隔一段时间接收并应用之，如果在那段时间内没有收到，就持续等待。</strong>所以我们必须设置好合适的时间，令服务端和客户端之间配合无间。<br>　　在我的设计里，为服务端和客户端都设置了帧（Frame）的概念，每Update一次即是一帧，每次Update的间隔时间为<em>17毫秒</em>，这个数字是根据(1/60)秒取整得出。每隔三帧服务端便会发送同步包，而客户端则是每帧都会接收，每隔三帧便会应用之。我称这种每隔三帧的帧为<strong>同步帧</strong>。<br>　　衡量设置是否良好，主要看每帧接收的同步包的数量，以及每秒帧数的多少。正常情况下，每帧接收的同步包的数量应是0-1，如果超过这个数值，证明服务端或客户端其中一方的频率太快或太慢。至于每秒帧数的多少，则能看出发送频率是否过剩，正常情况下在60左右即可，这和FPS的要求是类似的。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> event = host:service(<span class="number">17</span>) <span class="comment">--服务端每隔17毫秒接收一次封包</span></div></pre></td></tr></table></figure>
<h3 id="收包Q-amp-A"><a href="#收包Q-amp-A" class="headerlink" title="收包Q&amp;A"></a>收包Q&amp;A</h3><ul>
<li>关于收包的问题，有个最明显的问题便是为何不是在同步帧时进行收包，而是每帧都尝试收包？<ul>
<li>这是因为收包的内容不仅仅是关于帧同步，还可能有其他东西。其次便是先收后收并不影响什么，以及每隔三帧才进行一次收包恐怕会卡。</li>
</ul>
</li>
<li>关于一次性收到多个同步包的情况时，该怎么办？<ul>
<li>遇到收到多个同步包的情况，说明客户端失联了一段时间，这时候便需要一次性进行多次Update以迅速追回进度。</li>
</ul>
</li>
<li>既然确定遇到多个同步包时需要一次性追回进度，那为何不选择在接收后立即执行，而要等到同步帧？<ul>
<li>因为基本上不会遇到这种情况，能遇到多个同步包的情况，一般客户端已经在等待了。换做客户端卡住这种情况的话，根据Fixed Update的规则，本来就会立即赶到同步帧的。</li>
</ul>
</li>
<li>为何等待同步包的代码并非是阻塞式的，而是每帧去判定一下？<ul>
<li>因为如果是阻塞式的话，会使得DT变得很大，影响Fixed Update。</li>
</ul>
</li>
</ul>
<h3 id="输入应用"><a href="#输入应用" class="headerlink" title="输入应用"></a>输入应用</h3><p>　　关于输入应用方面，首先要明确一点：客户端每次按下/释放按键，就会改写输入表然后发送之。服务端收到后便会改写在服务端的对应输入表。这种模式在高延迟的表现便是呈现出某些按键因为一直按下而导致一些鬼畜操作，这点算是可以接受的。<br>　　另外注意不要贪图方便每次只发送当前修改的按键，这样会失去输入的稳定性，一旦发生丢包之类的，会产生键盘失灵的感觉。<br>　　在每次同步帧时便会根据同步包的内容更新所有玩家的输入表，从而改变每个联机角色的操作。这个输入表会一直应用到下次同步帧之前，从这点来看帧同步也是一种回合制。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--根据同步包的内容更新所有玩家的输入表(main.lua)</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (frame % <span class="number">3</span> == <span class="number">0</span>) <span class="keyword">then</span></div><div class="line">	<span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(playList[<span class="number">1</span>]) <span class="keyword">do</span></div><div class="line">		<span class="keyword">if</span> (userMap[k]) <span class="keyword">then</span></div><div class="line">			userMap[k].input = v</div><div class="line">		<span class="keyword">end</span></div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	playFrame = playFrame + <span class="number">1</span></div><div class="line">	<span class="built_in">table</span>.remove(playList, <span class="number">1</span>)</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--客户端每次按下/释放按键，就会改写输入表然后发送之(main.lua)</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">love.keypressed</span><span class="params">(key)</span></span></div><div class="line">	<span class="keyword">if</span> (key == <span class="string">"up"</span> <span class="keyword">or</span> key == <span class="string">"down"</span> <span class="keyword">or</span> key == <span class="string">"left"</span> <span class="keyword">or</span> key == <span class="string">"right"</span>) <span class="keyword">then</span></div><div class="line">		input[key] = <span class="number">1</span></div><div class="line">		Lib.Send(server, <span class="string">"input"</span>, input)</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">love.keyreleased</span><span class="params">(key)</span></span></div><div class="line">	<span class="keyword">if</span> (key == <span class="string">"up"</span> <span class="keyword">or</span> key == <span class="string">"down"</span> <span class="keyword">or</span> key == <span class="string">"left"</span> <span class="keyword">or</span> key == <span class="string">"right"</span>) <span class="keyword">then</span></div><div class="line">		input[key] = <span class="number">0</span></div><div class="line">		Lib.Send(server, <span class="string">"input"</span>, input)</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h3 id="断线重连-中途加入"><a href="#断线重连-中途加入" class="headerlink" title="断线重连/中途加入"></a>断线重连/中途加入</h3><p>　　想要做到这两点，便需要做到在服务端保存每一份同步包，这样服务端只需要记录每个玩家的初始数据，在新玩家加入游戏时，首先发送每个玩家的初始数据给新玩家同步，然后再把所有同步包打包发送给新玩家，让新玩家一次性Update，即可完成中途加入。当然不要忘记给现有玩家发送新玩家的数据。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--新玩家同步(main.lua)</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> event, <span class="built_in">type</span>, ip, data</div><div class="line"></div><div class="line"><span class="keyword">repeat</span></div><div class="line">	event = host:service()</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (event) <span class="keyword">then</span></div><div class="line">		<span class="built_in">type</span>, ip, data = Lib.Recv(event)</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">until</span> event ~= <span class="keyword">nil</span> <span class="keyword">and</span> <span class="built_in">type</span> == <span class="string">"loginSuccess"</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(data.users) <span class="keyword">do</span></div><div class="line">	<span class="keyword">local</span> actor = NewActor(v.x, v.y, v.ip)</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> (v.ip == data.ip) <span class="keyword">then</span></div><div class="line">		player = actor</div><div class="line">		<span class="built_in">print</span>(<span class="string">"loginSuccess"</span>, v.ip)</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">playList = data.playList</div><div class="line"></div><div class="line"><span class="keyword">while</span> (#playList &gt; <span class="number">0</span>) <span class="keyword">do</span></div><div class="line">	Update()</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h3 id="浮点数"><a href="#浮点数" class="headerlink" title="浮点数"></a>浮点数</h3><p>　　根据网上的信息看来，浮点数因为在不同环境的实现有所偏差，所以可能会导致不一致的问题，这样便会产生蝴蝶效应，最终导致同步失效。目前我使用LuaJIT在Windows(x64)、Ubuntu(x64)、macOS、Android(红米Note4)、iOS测试来看，浮点数在「输出」的场合下并无不同。当然只是输出，并不能代表真实数据的情况。以及我的测试范本并不算多，对于浮点数的问题还不敢保证。所以我选择在业务层放弃使用浮点数，相关数据都事先进行转换，到最后需要浮点数的对接场合再进行转换。当然我并不敢保证这种做法的可行性，真正成熟的做法应该是使用定点数，但我暂时并未这么做。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dt = <span class="built_in">math</span>.floor(dt * <span class="number">1000</span>) <span class="comment">-- 浮点数转换为整数（毫秒）</span></div></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>　　以上便是本次我对帧同步的初步探究，它注定是不成熟的，需要经过实践的检验，接下来我会考虑将其接入到一些项目中。有相关经验的朋友欢迎前来讨论。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://musoucrow.github.io/2017/07/21/spk_analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Musoucrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Musoucrow' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/21/spk_analysis/" itemprop="url">
                  DNF的SPK文件解析笔记
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-21T15:57:42+08:00">
                2017-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Analysis/" itemprop="url" rel="index">
                    <span itemprop="name">Analysis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/21/spk_analysis/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/21/spk_analysis/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/21/spk_analysis/" class="leancloud_visitors" data-flag-title="DNF的SPK文件解析笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　<strong>欢迎参与讨论，转载请注明出处。</strong></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>　　SPK文件是<a href="http://dnf.qq.com" target="_blank" rel="external">DNF</a>的一种更新时所用的压缩包（国服除外），在更新时会从服务器下载这种SPK文件然后于本地解压。有时候为了获得更快的速度，以及突破墙的限制，我们通过获取到更新服务器的网址直接下载。但是此刻对于如何将SPK文件解压便是个问题了，本文遂由此而生。</p>
<h2 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h2><p>　　SPK文件的本质上是将原文件按照一定规则进行分割成多个片段，然后对这些片段使用<a href="http://www.bzip.org" target="_blank" rel="external">bzip2</a>算法进行压缩。以下是文件结构图：<img src="https://musoucrow.github.io/images/spk_analysis/1.png" alt="1"></p>
<p>　　由于信息的不对称，导致不少地方是处于盲区的，不过这并不影响获取到关键数据。这种被压缩的片段开头标识为”BZh91AY&amp;SY”，所以只需要以此为关键字进行分割就能得出关键数据了，不过实际操作时发现除了压缩数据之外还有非压缩数据，并且会用一段48字节的数据进行分隔。且拥有非压缩数据的片段结尾也会有一段意味不明的数据，好在它们都有对应的开头标识，进行分割即可。<br>　　在得出压缩数据后使用bzip2算法进行解压缩，然后将所有解压后的数据与非压缩数据按顺序进行拼接，每个片段如此类推最后总体拼接起来即可得到完整的原文件。本次解析使用的环境是Python3.6，以下是过程代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> bz2</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"></div><div class="line"></div><div class="line">HEADER = <span class="string">b"BZh91AY&amp;SY"</span></div><div class="line">MARK = <span class="string">b"\x00\x00\x00\x00\x00\x10\x0e\x00\xff\xff\xff\xff\xff\xef\xf1\xff"</span></div><div class="line"><span class="comment"># 00 00 00 00 00 10 0E 00 FF FF FF FF FF EF F1 FF</span></div><div class="line">TAIL = <span class="string">b"\x01\x00\x00\x00"</span>  <span class="comment"># 01 00 00 00</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decompress_spk</span><span class="params">(path)</span>:</span></div><div class="line">    f = open(path, <span class="string">"rb"</span>)</div><div class="line"></div><div class="line">    f.read(<span class="number">4</span>)  <span class="comment"># unknown, all files are same.</span></div><div class="line">    f.read(<span class="number">260</span>)  <span class="comment"># total 260 bits, contain name and buffer.</span></div><div class="line">    f.read(<span class="number">4</span>)  <span class="comment"># unknown, all files are same.</span></div><div class="line">    struct.unpack(<span class="string">'i'</span>, f.read(<span class="number">4</span>))[<span class="number">0</span>]  <span class="comment"># decompress_size</span></div><div class="line"></div><div class="line">    content = f.read()</div><div class="line">    parts = content.split(HEADER)</div><div class="line">    f.close()</div><div class="line"></div><div class="line">    new_content = <span class="string">b""</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">1</span>, len(parts)):</div><div class="line">        lst = parts[n].split(MARK)</div><div class="line">        length = len(lst)</div><div class="line">        new_content = new_content + bz2.decompress(HEADER + lst[<span class="number">0</span>])</div><div class="line"></div><div class="line">        <span class="keyword">if</span> length &gt; <span class="number">1</span>:</div><div class="line">            <span class="keyword">for</span> m <span class="keyword">in</span> range(<span class="number">1</span>, length - <span class="number">1</span>):</div><div class="line">                new_content = new_content + lst[m][<span class="number">32</span>:]</div><div class="line"></div><div class="line">            pos = lst[length - <span class="number">1</span>].rfind(TAIL)</div><div class="line">            new_content = new_content + lst[length - <span class="number">1</span>][<span class="number">32</span>:pos]</div><div class="line"></div><div class="line">    f2 = open(path[:<span class="number">-4</span>], <span class="string">"wb"</span>)</div><div class="line">    f2.write(new_content)</div><div class="line">    f2.close()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span> <span class="keyword">and</span> len(sys.argv) &gt; <span class="number">1</span>:</div><div class="line">    decompress_spk(sys.argv[<span class="number">1</span>])</div></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>　　事实上这种SPK的压缩机制效果根本是微乎其微，我完全不明白Neople这么做的用意。以及片段的划分机制和诸多盲区都没搞懂，看来我得考虑学下逆向方面的知识了。不过无论如何，最终要达到的目标还是做到了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://musoucrow.github.io/2017/07/16/socket_listen/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Musoucrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Musoucrow' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/16/socket_listen/" itemprop="url">
                  关于Socket.listen方法的一点体悟
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-16T11:58:36+08:00">
                2017-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/" itemprop="url" rel="index">
                    <span itemprop="name">Network</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/16/socket_listen/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/07/16/socket_listen/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/16/socket_listen/" class="leancloud_visitors" data-flag-title="关于Socket.listen方法的一点体悟">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　<strong>欢迎参与讨论，转载请注明出处。</strong></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>　　最近在接触<a href="https://docs.python.org/3/library/socket.html#module-socket" target="_blank" rel="external">Socket</a>的的时候，关于其中的listen方法感到不解，于是对其进行了一番研究，得出了一点体悟，特此记录。</p>
<h2 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h2><p>　　让我们先来看看listen方法在Python3.6文档说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">socket.listen([backlog])</div><div class="line"></div><div class="line">Enable a server to accept connections. If backlog is specified, it must be at least 0 (if it is lower, it is set to 0); it specifies the number of unaccepted connections that the system will allow before refusing new connections. If not specified, a default reasonable value is chosen.</div><div class="line">启用服务器以接受连接。如果指定backlog，则必须至少为0（如果低于0，则设置为0）；它指定系统在拒绝新连接之前将允许的未接受连接的数量。如果未指定，则选择默认的合理值。</div><div class="line"></div><div class="line">Changed in version 3.5: The backlog parameter is now optional.</div><div class="line">在版本3.5中已更改： backlog参数现在是可选的。</div></pre></td></tr></table></figure>
<p>　　起初我看了这说明想当然的以为是可以接入的Client上限，不过实践过后发现并非如此。在网上找的解答基本上就是文档所言的复述，后来请教了专业人士后，方知这涉及到Socket的底层知识。<br>　　在了解listen方法之前，首先我们需要了解connect方法和accept方法，以下是文档说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">socket.connect(address)</div><div class="line"></div><div class="line">Connect to a remote socket at address. (The format of address depends on the address family — see above.)</div><div class="line">在地址连接到远程套接字。（地址的格式取决于地址系列 - 请参见上文）</div><div class="line"></div><div class="line">If the connection is interrupted by a signal, the method waits until the connection completes, or raise a socket.timeout on timeout, if the signal handler doesn’t raise an exception and the socket is blocking or has a timeout. For non-blocking sockets, the method raises an InterruptedError exception if the connection is interrupted by a signal (or the exception raised by the signal handler).</div><div class="line">如果连接被信号中断，则该方法等待直到连接完成，或者如果信号处理程序没有引发异常并且套接字正在阻塞或者已经阻塞，则在超时时引入socket.timeout超时。对于非阻塞套接字，如果连接被信号中断（或由信号处理程序引发的异常），则该方法引发InterruptedError异常。</div><div class="line"></div><div class="line">Changed in version 3.5: The method now waits until the connection completes instead of raising an InterruptedError exception if the connection is interrupted by a signal, the signal handler doesn’t raise an exception and the socket is blocking or has a timeout (see the PEP 475 for the rationale).</div><div class="line">在版本3.5中已更改：该方法现在等待直到连接完成，而不是提高InterruptedError异常，如果连接被信号中断，信号处理程序不引发异常，套接字阻塞或超时（参见 PEP 475）。</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">socket.accept()</div><div class="line"></div><div class="line">Accept a connection. The socket must be bound to an address and listening for connections. The return value is a pair (conn, address) where conn is a new socket object usable to send and receive data on the connection, and address is the address bound to the socket on the other end of the connection.</div><div class="line">接收一个连接.该socket 必须要绑定一个地址和监听连接.返回值是一对（conn， 地址）其中conn是新 t4 &gt; socket对象可用于在连接上发送和接收数据，address是连接另一端的套接字的地址。</div><div class="line"></div><div class="line">The newly created socket is non-inheritable.</div><div class="line">新创建的套接字non-inheritable。</div><div class="line"></div><div class="line">Changed in version 3.4: The socket is now non-inheritable.</div><div class="line">在版本3.4中更改：套接字现在是不可继承的。</div><div class="line"></div><div class="line">Changed in version 3.5: If the system call is interrupted and the signal handler does not raise an exception, the method now retries the system call instead of raising an InterruptedError exception (see PEP 475 for the rationale).</div><div class="line">在版本3.5中更改：如果系统调用中断并且信号处理程序没有引发异常，则此方法现在重试系统调用，而不是引发InterruptedError异常 PEP 475）。</div></pre></td></tr></table></figure>
<p>　　相比listen方法，它俩就好理解多了，一个是Client用于连接Server的方法，一个是Server用于接收Client的连接申请的方法。<br>　　但事实上accept方法一次只能接收一个Client的连接申请，而Client则是多个的，这样Socket会设计一个队列来存储Client的连接申请则是理所当然的。于是accept便从这个队列里提取首位成员处理即可。以下是示意图：<img src="https://musoucrow.github.io/images/socket_listen/1.png" alt="1"></p>
<p>　　如此便很清晰了，backlog参数的含义便是这个队列的最大值，也就是同时受理连接申请的最大值。关于backlog该设置为多少，从<a href="https://github.com/cloudwu/skynet" target="_blank" rel="external">Skynet</a>得到的参考为32。如果满了便需要Client重新connect。以上listen方法之谜便解开了。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>　　不得不说网络编程的水真的很深，我也得买点书充充电了，目前的目标为啃下谢希仁著的《计算机网络》。另外推荐《TCP/IP详解》及《UNIX网络编程》。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://musoucrow.github.io/2017/06/16/mvc_thinking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Musoucrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Musoucrow' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/16/mvc_thinking/" itemprop="url">
                  关于MVC框架的一点体悟
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-16T15:29:44+08:00">
                2017-06-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ProgramDesign/" itemprop="url" rel="index">
                    <span itemprop="name">ProgramDesign</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/06/16/mvc_thinking/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/16/mvc_thinking/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/06/16/mvc_thinking/" class="leancloud_visitors" data-flag-title="关于MVC框架的一点体悟">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　<strong>欢迎参与讨论，转载请注明出处。</strong></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>　　<a href="http://baike.baidu.com/link?url=zYMmkOVIZhbMUbKeHEMyR3Ceg7j_KED4dv0puXavoS2QEVLUO-nmmpcadj1YtyOnnxQca5kxrX9t-v5UKZqoE0dkPehKNji5A5MzLJdQwbTm00psL_0txg8xMNWu0d9WEa896dz92JY-Kitfd5L3D_" target="_blank" rel="external">MVC框架</a>相信大家都有所耳闻，不过想必没有深入接触的话，大多是知其然而不知其所以然。而本人几乎没有GUI软件的开发经验，只是走马观花般的碰过几下.NET的Winform之类，所以之前自然也是如此。<br>　　而近日帮助友人使用C++/CLI完成一款篮球比赛记录软件，在思考要如何搭建架构时很自然的选择了将核心和界面分离的设计，在完成后我感觉Winform把自动生成的代码和人为实现的事件接口放一起很是冗杂。于是选择用Python重新实现一次，随着把界面数据和事件接口的分离，赫然发现：这不就是传说中的MVC框架么？<img src="https://musoucrow.github.io/images/mvc_thinking/directory.png" alt="directory"></p>
<h2 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h2><p>　　当然有一点是需要明确的：我实现的这套「MVC框架」并不算标准，并且为了便利性还牺牲了一点解耦性，以下仅供参考。<br>　　<img src="https://musoucrow.github.io/images/mvc_thinking/relationship.png" alt="relationship"><br>　　以上的core, interface, design分别是三个模块，代表着MVC框架下的model, controller, view。箭头表明了引用关系（例：interface调用了core的功能）。<br>　　如图所示，interface和design都引用了core，而core并没有引用其他模块。由此可见，core是完全独立于界面的，无论是怎样的界面，只要对接好core就没有问题，这正是「业务和界面分离」。<br>　　而interface和design，实际上是可以解耦的。不过这需要令design使用一些手段监听core的数据是否发生了变化，我认为这样的实现颇为复杂，况且interface和design本为一一对应的关系（interface是界面事件，design是界面数据），所以也不必苛求解耦。遂选择由interface通知design去同步core的数据。  </p>
<h2 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h2><p>　　本演示使用Python3编写，界面使用了<a href="https://riverbankcomputing.com/software/pyqt/intro" target="_blank" rel="external">Pyqt5</a>，理解这个演示你需要了解<a href="https://www.python.org" target="_blank" rel="external">Python</a>以及<a href="https://www.qt.io" target="_blank" rel="external">Qt</a>。项目地址:<a href="https://git.coding.net/musoucrow/MVCShow.git" target="_blank" rel="external">MVCShow.git</a><br>　　演示的内容十分简单，仅是一个窗口包含了一个文本框和按钮而已。通过点击按钮来改变文本框的内容。  </p>
<ul>
<li>点击前：<img src="https://musoucrow.github.io/images/mvc_thinking/before.png" alt="before"></li>
<li>点击后：<img src="https://musoucrow.github.io/images/mvc_thinking/after.png" alt="after"></li>
<li>流程图：<img src="https://musoucrow.github.io/images/mvc_thinking/progress.png" alt="progress"></li>
<li>代码展示：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># core</span></div><div class="line"></div><div class="line">__value = <span class="string">"123"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_value</span><span class="params">(value)</span>:</span></div><div class="line">    <span class="keyword">global</span> __value</div><div class="line">    __value = value</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_value</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> __value</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># design</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> core</div><div class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore, QtWidgets</div><div class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> QMainWindow</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EntryDesign</span><span class="params">(QMainWindow)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        super(EntryDesign, self).__init__()</div><div class="line"></div><div class="line">        self.setObjectName(<span class="string">"MVCShow"</span>)</div><div class="line">        self.resize(<span class="number">400</span>, <span class="number">300</span>)</div><div class="line">        self.pushButton = QtWidgets.QPushButton(self)</div><div class="line">        self.pushButton.setGeometry(QtCore.QRect(<span class="number">150</span>, <span class="number">210</span>, <span class="number">113</span>, <span class="number">32</span>))</div><div class="line">        self.pushButton.setObjectName(<span class="string">"pushButton"</span>)</div><div class="line">        self.lineEdit = QtWidgets.QLineEdit(self)</div><div class="line">        self.lineEdit.setGeometry(QtCore.QRect(<span class="number">150</span>, <span class="number">110</span>, <span class="number">113</span>, <span class="number">21</span>))</div><div class="line">        self.lineEdit.setObjectName(<span class="string">"lineEdit"</span>)</div><div class="line"></div><div class="line">        self.retranslateUi()</div><div class="line">        QtCore.QMetaObject.connectSlotsByName(self)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">retranslateUi</span><span class="params">(self)</span>:</span></div><div class="line">        _translate = QtCore.QCoreApplication.translate</div><div class="line">        self.setWindowTitle(_translate(<span class="string">"MVCShow"</span>, <span class="string">"MVCShow"</span>))</div><div class="line">        self.pushButton.setText(_translate(<span class="string">"MVCShow"</span>, <span class="string">"click"</span>))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">refresh</span><span class="params">(self)</span>:</span></div><div class="line">        self.lineEdit.setText(core.get_value())</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># interface</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> core</div><div class="line"><span class="keyword">from</span> design.entry <span class="keyword">import</span> EntryDesign</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Entry</span><span class="params">(EntryDesign)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, )</span>:</span></div><div class="line">        super(Entry, self).__init__()</div><div class="line">        self.pushButton.clicked.connect(self.__pushButton_clicked)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">showEvent</span><span class="params">(self, event)</span>:</span></div><div class="line">        self.refresh()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__pushButton_clicked</span><span class="params">(self)</span>:</span></div><div class="line">        core.set_value(<span class="string">"456"</span>)</div><div class="line">        self.refresh()</div></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>　　框架是死的，思想是活的。在实际开发中，并不需要教科书般地去套用模板，事实上大家实现的MVC框架也不尽相同。而我认为MVC框架的核心思想便是「界面与业务分离，数据与逻辑分离」。只要把握好这个核心思想去做即可。对此有所心得者，欢迎前来探讨，提供更佳的思路。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://musoucrow.github.io/2017/05/01/png_stroke_problem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Musoucrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Musoucrow' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/01/png_stroke_problem/" itemprop="url">
                  关于像素PNG图片在游戏引擎缩放后出现毛边的解决方案
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-01T06:35:55+08:00">
                2017-05-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Teach/" itemprop="url" rel="index">
                    <span itemprop="name">Teach</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/01/png_stroke_problem/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/05/01/png_stroke_problem/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/05/01/png_stroke_problem/" class="leancloud_visitors" data-flag-title="关于像素PNG图片在游戏引擎缩放后出现毛边的解决方案">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　<strong>欢迎参与讨论，转载请注明出处。</strong></p>
<p>　　今日遇到了一个很值得记录的问题：对于像素PNG图片在游戏引擎里缩放后，便会在图片边缘出现很奇怪的毛边。类似这样：<img src="https://musoucrow.github.io/images/png_stroke_problem/1.png" alt="1">  </p>
<p>　　经过研究发现，似乎与文件格式无关。我还尝试将不会出现毛边的像素图混搭一块，结果反而导致靠近毛边的地方会被感染：<img src="https://musoucrow.github.io/images/png_stroke_problem/2.png" alt="2"></p>
<p>　　当然这个问题在Unity下是可以通过设置解决的：<img src="https://musoucrow.github.io/images/png_stroke_problem/3.png" alt="3"></p>
<p>　　不过并非所有游戏引擎都能这么做的，所以还需要从文件根本上解决。经过一段无心插柳的尝试，发现解决方案为使用PS的文件→存储为Web所用格式：<img src="https://musoucrow.github.io/images/png_stroke_problem/4.png" alt="4"></p>
<p>　　关键便在于将杂边设置为“无”，保存后再拿去测试，问题解决：<img src="https://musoucrow.github.io/images/png_stroke_problem/5.png" alt="5"></p>
<p>　　虽然到头来具体的原理还是没有弄明白，但好歹也算是解决了。如果有人明白具体原理，还请不吝赐教。至于这么做是否有损尚未可知，但从肉眼来看是不成问题的。以及这个问题目前只发现出现在像素图上，带半透明的特效图并无此问题。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://musoucrow.github.io/2017/04/21/caller/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Musoucrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Musoucrow' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/21/caller/" itemprop="url">
                  观察者模式的一种实现——Caller
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-21T16:55:56+08:00">
                2017-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ProgramDesign/" itemprop="url" rel="index">
                    <span itemprop="name">ProgramDesign</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/21/caller/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/21/caller/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/04/21/caller/" class="leancloud_visitors" data-flag-title="观察者模式的一种实现——Caller">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　<strong>欢迎参与讨论，转载请注明出处。</strong>      </p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>　　在程序设计的时候，观察者模式是一种应用广泛的设计模式，它是一种模块间的通信方式，对于程序的解耦性有所帮助。本文便提供了一种实现思路，也即是说，你需要<strong>先去了解观察者模式</strong>才方便阅读本文。<br>　　以下代码演示将使用Lua语言，接下来的内容对阅读者的Lua水平有一定的要求。如果你不知道在Lua中class的实现方式，可参考<a href="http://blog.codingnow.com/2006/06/oo_lua.html" target="_blank" rel="external">这篇文章</a>。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>　　首先构造Caller的结构关系，如图所示：<img src="https://musoucrow.github.io/images/caller/relationship.png" alt="relationship"></p>
<p>　　由此可见，Caller包含一个结构体——Listener。接下来是代码实现：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- Caller.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> Caller = Class()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Caller:Ctor</span><span class="params">()</span></span></div><div class="line">	self.listenerList = &#123;&#125;</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Caller:AddListener</span><span class="params">(obj, func)</span></span></div><div class="line">	<span class="built_in">table</span>.insert(self.listenerList, &#123;obj = obj, func = func&#125;) <span class="comment">-- Create Listener.</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Caller:DelListener</span><span class="params">(obj, func)</span></span></div><div class="line">	<span class="keyword">for</span> n=#self.listenerList, <span class="number">1</span>, <span class="number">-1</span> <span class="keyword">do</span></div><div class="line">		<span class="keyword">if</span> (self.listenerList[n].obj == obj <span class="keyword">and</span> self.listenerList[n].func == func) <span class="keyword">then</span></div><div class="line">			<span class="built_in">table</span>.remove(self.listenerList, n)</div><div class="line">			</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span></div><div class="line">		<span class="keyword">end</span></div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Caller:Call</span><span class="params">(...)</span></span></div><div class="line">	<span class="keyword">for</span> n=<span class="number">1</span>, #self.listenerList <span class="keyword">do</span></div><div class="line">		self.listenerList[n].func(self.listenerList[n].obj, ...)</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> Caller</div></pre></td></tr></table></figure>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- A.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> Caller = <span class="built_in">require</span>(<span class="string">"caller"</span>)</div><div class="line"><span class="keyword">local</span> B = <span class="built_in">require</span>(<span class="string">"b"</span>)</div><div class="line"><span class="keyword">local</span> A = Class()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">A:Ctor</span><span class="params">()</span></span></div><div class="line">	self.caller = Caller.New()</div><div class="line">	self.b = B.New(self.caller)</div><div class="line">	self.value = <span class="number">0</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">A:SetValue</span><span class="params">(value)</span></span></div><div class="line">	self.value = value</div><div class="line">	self.caller:Call(value)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> A</div></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- B.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> B = Class()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">B:Ctor</span><span class="params">(caller)</span></span></div><div class="line">	caller:AddListener(self, self.Print)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">B:Print</span><span class="params">(...)</span></span></div><div class="line">	<span class="built_in">print</span>(...)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> B</div></pre></td></tr></table></figure>
<p>　　如上所示，在调用A:SetValue(value)时会连带调用B:Print(…)，如此只需要通过操作Caller就能达到不同对象之间通信的效果。并且也无须将业务写死在A:SetValue(value)中，业务将集中存放在Caller中。</p>
<h2 id="疑难解答"><a href="#疑难解答" class="headerlink" title="疑难解答"></a>疑难解答</h2><p>　　问：Caller的缺点是什么？<br>　　答：Caller的缺点的很明显，需要将Caller对象直传到其他模块处，这样并不是很安全（别处也可以做Caller的一切行为）。当然这个问题也很好解决，只需要采用<a href="https://musoucrow.github.io/2017/04/19/event_mechanism/">Event机制</a>对其进行封装即可。代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- A.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> Caller = <span class="built_in">require</span>(<span class="string">"caller"</span>)</div><div class="line"><span class="keyword">local</span> B = <span class="built_in">require</span>(<span class="string">"b"</span>)</div><div class="line"><span class="keyword">local</span> A = Class()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">A:Ctor</span><span class="params">()</span></span></div><div class="line">	self.event = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span> self:OnEvent(...) <span class="keyword">end</span></div><div class="line">	self.caller = Caller.New()</div><div class="line">	self.b = B.New()</div><div class="line">	self.value = <span class="number">0</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">A:SetValue</span><span class="params">(value)</span></span></div><div class="line">	self.value = value</div><div class="line">	self.caller:Call(value)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">A:OnEvent</span><span class="params">(type, ...)</span></span></div><div class="line">	<span class="keyword">if</span> (<span class="built_in">type</span> == <span class="string">"AddListener"</span>) <span class="keyword">then</span></div><div class="line">		<span class="keyword">return</span> self.caller:AddListener(...)</div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="keyword">return</span> <span class="string">"No Event"</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> A</div></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- B.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> B = Class()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">B:Ctor</span><span class="params">(upperEvent)</span></span></div><div class="line">	upperEvent(<span class="string">"AddListener"</span>, self, self.Print)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">B:Print</span><span class="params">(...)</span></span></div><div class="line">	<span class="built_in">print</span>(...)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> B</div></pre></td></tr></table></figure>
<p>　　问：Caller在功能上有何可改进之处？<br>　　答：在实际开发中，Caller的需求数量一般不止一个，届时可以考虑用List或Map对Caller进行管理。也可以考虑直接让Caller具备管理多个ListenerList，代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- Caller.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> Caller = Class()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Caller:Ctor</span><span class="params">()</span></span></div><div class="line">	self.listenerListMap = &#123;&#125;</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Caller:AddListener</span><span class="params">(type, obj, func)</span></span></div><div class="line">	<span class="keyword">if</span> (<span class="keyword">not</span> self.listenerListMap[<span class="built_in">type</span>]) <span class="keyword">then</span></div><div class="line">		self.listenerListMap[<span class="built_in">type</span>] = &#123;&#125;</div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="built_in">table</span>.insert(self.listenerListMap[<span class="built_in">type</span>], &#123;obj = obj, func = func&#125;) <span class="comment">-- Create Listener.</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Caller:DelListener</span><span class="params">(type, obj, func)</span></span></div><div class="line">	<span class="keyword">if</span> (<span class="keyword">not</span> self.listenerListMap[<span class="built_in">type</span>]) <span class="keyword">then</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span></div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="keyword">local</span> listenerList = self.listenerListMap[<span class="built_in">type</span>]</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> n=#listenerList, <span class="number">1</span>, <span class="number">-1</span> <span class="keyword">do</span></div><div class="line">		<span class="keyword">if</span> (listenerList[n].func == func <span class="keyword">and</span> listenerList[n].obj == obj) <span class="keyword">then</span></div><div class="line">			<span class="built_in">table</span>.remove(listenerList, n)</div><div class="line">			</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span></div><div class="line">		<span class="keyword">end</span></div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Caller:Call</span><span class="params">(type, ...)</span></span></div><div class="line">	<span class="keyword">if</span> (<span class="keyword">not</span> self.listenerListMap[<span class="built_in">type</span>]) <span class="keyword">then</span></div><div class="line">		<span class="keyword">return</span></div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="keyword">local</span> listenerList = self.listenerListMap[<span class="built_in">type</span>]</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> n=#listenerList, <span class="number">1</span>, <span class="number">-1</span> <span class="keyword">do</span></div><div class="line">		listenerList[n].func(listenerList[n].obj, ...)</div><div class="line">	<span class="keyword">end</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> Caller</div></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>　　以上内容仅为提供一个思路，它或许并非最完善的，也不一定能适用于所有编程语言中，对此有所心得者，欢迎前来探讨，提供更佳的思路。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://musoucrow.github.io/2017/04/19/event_mechanism/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Musoucrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Musoucrow' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/19/event_mechanism/" itemprop="url">
                  浅谈对象之间通信的解决方案——Event机制
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-19T12:22:48+08:00">
                2017-04-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ProgramDesign/" itemprop="url" rel="index">
                    <span itemprop="name">ProgramDesign</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/04/19/event_mechanism/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/04/19/event_mechanism/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/04/19/event_mechanism/" class="leancloud_visitors" data-flag-title="浅谈对象之间通信的解决方案——Event机制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　<strong>欢迎参与讨论，转载请注明出处。</strong>      </p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>　　在程序设计的时候，不同对象与模块间总是不可避免会发生相互调用的情况，如果选择将对象互相作为参数传入给对方使用，那么这种现象一般被称为<strong>耦合</strong>，这样实际上就让两个部分连在了一块。当然这样子实际上并没有什么问题，只要这符合你的设计预期。只是一旦开发规模增大、开发人员增多、耦合程度加剧的话，程序的维护成本也便会随之剧增。往往会出现某个模块在另一个模块处被做了一些修改而不自知，以及在脚本语言的情况下，没有private保护的对象到了他处等同彻底的暴露，随便的修改的话，封装性也随之不存。那么由此看来，必须拥有一套对象之间通信的解决方案了，本文便是提供了一种思路供给参考。<br>　　以下代码演示将使用Lua语言，接下来的内容对阅读者的Lua水平有一定的要求。如果你不知道在Lua中class的实现方式，可参考<a href="http://blog.codingnow.com/2006/06/oo_lua.html" target="_blank" rel="external">这篇文章</a>。</p>
<h2 id="使用机制之前的做法"><a href="#使用机制之前的做法" class="headerlink" title="使用机制之前的做法"></a>使用机制之前的做法</h2><p>　　首先我们演示一下不用Event机制之前的做法，也就是一般人会用的做法。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- A.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> A = Class()</div><div class="line"><span class="keyword">local</span> B = <span class="built_in">require</span>(<span class="string">"b"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">A:Ctor</span><span class="params">()</span></span></div><div class="line">	self.value = <span class="number">1</span></div><div class="line">	self.b = B.New(self)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> A</div></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- B.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> B = Class()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">B:Ctor</span><span class="params">(a)</span></span></div><div class="line">	self.a = a</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">B:Print</span><span class="params">()</span></span></div><div class="line">	<span class="built_in">print</span>(self.a.value)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> B</div></pre></td></tr></table></figure>
<h2 id="使用机制之后的做法"><a href="#使用机制之后的做法" class="headerlink" title="使用机制之后的做法"></a>使用机制之后的做法</h2><p>　　由上可以看出，这种直传对象的做法其实是十分危险的，它很容易破坏封装性，并且会达到「你中有我，我中有你」的效果，并且这还是在上下级的情况下。接下来便演示下使用了Event机制后的做法。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- A.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> A = Class()</div><div class="line"><span class="keyword">local</span> B = <span class="built_in">require</span>(<span class="string">"b"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">A:Ctor</span><span class="params">()</span></span></div><div class="line">	self.value = <span class="number">1</span></div><div class="line">	self.event = <span class="function"><span class="keyword">function</span><span class="params">(self, ...)</span></span> self:OnEvent(...) <span class="keyword">end</span></div><div class="line">	self.b = B.New(self.event)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">A:OnEvent</span><span class="params">(type, ...)</span></span></div><div class="line">	<span class="keyword">if</span> (<span class="built_in">type</span> == <span class="string">"GetValue"</span>) <span class="keyword">then</span></div><div class="line">		<span class="keyword">return</span> self.value</div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="keyword">return</span> <span class="string">"No Event"</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> A</div></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- B.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> B = Class()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">B:Ctor</span><span class="params">(upperEvent)</span></span></div><div class="line">	self.upperEvent = upperEvent</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">B:Print</span><span class="params">()</span></span></div><div class="line">	<span class="built_in">print</span>(self.upperEvent(<span class="string">"GetValue"</span>))</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> B</div></pre></td></tr></table></figure>
<p>　　通过对比可以看出，使用了Event机制后，不仅保证了封装性，而且还隔离了A对象的实现，换句话说，B对象的upperEvent已经不仅限于A了，只要是提供了一致的Event接口即可，并且A对象还能清除的知道自己对外究竟提供了什么接口，可维护性也随之提高了。<br>　　当然代价还是有的，那便是调用Event时的函数调用次数比传统方式有所增加，但我认为这是值得的。当然这只是一种思路，也未尝不可优化。</p>
<h2 id="疑难解答"><a href="#疑难解答" class="headerlink" title="疑难解答"></a>疑难解答</h2><p>　　问：关于两个平级对象需要相互调用要怎么做？<br>　　答：参考以下例子：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- A.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> A = Class()</div><div class="line"><span class="keyword">local</span> B = <span class="built_in">require</span>(<span class="string">"b"</span>)</div><div class="line"><span class="keyword">local</span> C = <span class="built_in">require</span>(<span class="string">"c"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">A:Ctor</span><span class="params">()</span></span></div><div class="line">	self.value = <span class="number">1</span></div><div class="line">	self.event = <span class="function"><span class="keyword">function</span><span class="params">(self, ...)</span></span> self:OnEvent(...) <span class="keyword">end</span></div><div class="line">	self.b = B.New(self.event)</div><div class="line">	self.c = C.New(self.event)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">A:OnEvent</span><span class="params">(type, ...)</span></span></div><div class="line">	<span class="keyword">if</span> (<span class="built_in">type</span> == <span class="string">"GetValue"</span>) <span class="keyword">then</span></div><div class="line">		<span class="keyword">return</span> self.b:GetValue()</div><div class="line">	<span class="keyword">elseif</span> (<span class="built_in">type</span> == <span class="string">"SetTag"</span>) <span class="keyword">then</span></div><div class="line">		<span class="keyword">return</span> self.c:SetValue(...)</div><div class="line">	<span class="keyword">end</span></div><div class="line">	</div><div class="line">	<span class="keyword">return</span> <span class="string">"No Event"</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> A</div></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- B.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> B = Class()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">B:Ctor</span><span class="params">(upperEvent)</span></span></div><div class="line">	self.upperEvent = upperEvent</div><div class="line">	self.value = <span class="number">1</span></div><div class="line"></div><div class="line">	self.upperEvent(<span class="string">"SetTag"</span>, <span class="string">"123"</span>)</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">B:GetValue</span><span class="params">()</span></span></div><div class="line">	<span class="keyword">return</span> self.value</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> B</div></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- C.lua</span></div><div class="line"></div><div class="line"><span class="keyword">local</span> Class = <span class="built_in">require</span>(<span class="string">"class"</span>)</div><div class="line"><span class="keyword">local</span> C = Class()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">C:Ctor</span><span class="params">(upperEvent)</span></span></div><div class="line">	self.upperEvent = upperEvent</div><div class="line">	self.tag = <span class="string">""</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">C:SetTag</span><span class="params">(tag)</span></span></div><div class="line">	self.tag = tag</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">C:Print</span><span class="params">()</span></span></div><div class="line">	<span class="built_in">print</span>(self.upperEvent(<span class="string">"GetValue"</span>))</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> C</div></pre></td></tr></table></figure>
<p>　　由此可见，平级对象的相互调用，只需要统一由上级管理好需要调用的接口，然后平级对象从上级Event中获取即可。</p>
<p>　　问：一个对象可以拥有多个OnEvent()么？也就是针对不同对象派出不同的Event。<br>　　答：一般来说不推荐这么做，因为这只会使得维护成本提升。当然你很清楚自己的需求以及这么做的代价的话，但试无妨。</p>
<p>　　问：使用Event机制后有效的保证了封装性，但是对于上级管理下级的时候并不存在这种封装性的保护，那么该怎么办呢？<br>　　答：这个在脚本语言里是一个没办法的事，原则上最好是不要对外直接暴露变量，只使用函数。哪怕这会带来更高的性能代价，对于维护性而言也是值得的，当然这个问题或许也可以通过特殊的手段解决（参考Lua元表的内容）。</p>
<p>　　问：是不是严格意义所有情况下都不应该直传对象而采用Event呢？<br>　　答：这样显然是不现实的，比如某些类的业务本身就需要获取到对象本身（如容器），以及Event本身也是有性能代价以及构建成本的，不可能面面俱到。在某些你认为必要且可掌控的情况下，直传对象也并非不可以。毕竟解耦的目的也是为了提高可维护性，只要你觉得这样做是可以接受的，那么便可以了。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>　　以上内容仅为提供一个思路，它或许并非最完善的，也不一定能适用于所有编程语言中，对此有所心得者，欢迎前来探讨，提供更佳的思路。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://musoucrow.github.io/2017/03/29/brew_changing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Musoucrow">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Musoucrow' BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/29/brew_changing/" itemprop="url">
                  更换Homebrew的更新源
                </a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-29T17:31:46+08:00">
                2017-03-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Teach/" itemprop="url" rel="index">
                    <span itemprop="name">Teach</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/29/brew_changing/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/29/brew_changing/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/03/29/brew_changing/" class="leancloud_visitors" data-flag-title="更换Homebrew的更新源">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>　　<strong>欢迎参与讨论，转载请注明出处。</strong></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>　　更换Homebrew的更新源的教程，在网上数不胜数，然内容大多大同小异且述之不详，且未提及版本上的差异。故作此文，以正视听。<br>　　在阅读此文之前，你需要了解<a href="https://brew.sh" target="_blank" rel="external">Homebrew</a>和<a href="https://git-scm.com" target="_blank" rel="external">Git</a>并安装了它们。并且对于Homebrew官方更新源的速度赶到不满且不打算利用其它手段解决（如VPN），或者看了其它文章感到不求甚解，那么此文对你而言是有价值的。</p>
<h2 id="更新源的机制"><a href="#更新源的机制" class="headerlink" title="更新源的机制"></a>更新源的机制</h2><p>　　Homebrew的更新源由三部分组成：本体（brew.git）、核心（homebrew-core.git）以及二进制预编译包（homebrew-bottles）。<br>　　在很多教程中，只会提及到更换本体，而未涉及到核心与二进制预编译包的更换。这样实际上效果是不完全的（尽管这样也无法做到完全，毕竟有一些软件包的地址是不被收录的，只能从它们提供的链接处下载）。<br>　　从.git的后缀名可以看出，Homebrew的更新源是以Git仓库的形式存在的，这便是为什么需要用到Git的原因。也正是如此，使得可以对其进行克隆，成为新源。  </p>
<h2 id="更新源的选择"><a href="#更新源的选择" class="headerlink" title="更新源的选择"></a>更新源的选择</h2><p>　　默认官方的更新源都是存放在<a href="https://github.com" target="_blank" rel="external">GitHub</a>上的，这也是中国大陆用户访问缓慢的原因，一般来说我们会更倾向选择国内提供的更新源，在此推荐<a href="https://mirrors.ustc.edu.cn/" target="_blank" rel="external">中国科大</a>以及<a href="https://mirrors.tuna.tsinghua.edu.cn/" target="_blank" rel="external">清华大学</a>提供的更新源，因为它们能够完整以上源组成的三个部分。并且在此感谢他们为大家提供的服务。
　　</p>
<h2 id="替换更新源"><a href="#替换更新源" class="headerlink" title="替换更新源"></a>替换更新源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 替换brew.git:</span></div><div class="line">$ <span class="built_in">cd</span> <span class="string">"<span class="variable">$(brew --repo)</span>"</span></div><div class="line"><span class="comment"># 中国科大:</span></div><div class="line">$ git remote <span class="built_in">set</span>-url origin https://mirrors.ustc.edu.cn/brew.git</div><div class="line"><span class="comment"># 清华大学:</span></div><div class="line">$ git remote <span class="built_in">set</span>-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git</div><div class="line"></div><div class="line"><span class="comment"># 替换homebrew-core.git:</span></div><div class="line">$ <span class="built_in">cd</span> <span class="string">"<span class="variable">$(brew --repo)</span>/Library/Taps/homebrew/homebrew-core"</span></div><div class="line"><span class="comment"># 中国科大:</span></div><div class="line">$ git remote <span class="built_in">set</span>-url origin https://mirrors.ustc.edu.cn/homebrew-core.git</div><div class="line"><span class="comment"># 清华大学:</span></div><div class="line">$ git remote <span class="built_in">set</span>-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git</div><div class="line"></div><div class="line"><span class="comment"># 替换homebrew-bottles:</span></div><div class="line"><span class="comment"># 中国科大:</span></div><div class="line">$ <span class="built_in">echo</span> <span class="string">'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.ustc.edu.cn/homebrew-bottles'</span> &gt;&gt; ~/.bash_profile</div><div class="line">$ <span class="built_in">source</span> ~/.bash_profile</div><div class="line"><span class="comment"># 清华大学:</span></div><div class="line">$ <span class="built_in">echo</span> <span class="string">'export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles'</span> &gt;&gt; ~/.bash_profile</div><div class="line">$ <span class="built_in">source</span> ~/.bash_profile</div><div class="line"></div><div class="line"><span class="comment"># 应用生效:</span></div><div class="line">$ brew update</div></pre></td></tr></table></figure>
<p>　　以上在中国科大和清华大学任选其一即可，在使用其他源的时候，最好先尝试访问其链接看看是否健在，并且因为历史原因，最初的brew.git是叫homebrew.git的，而现在部分更新源早已随官方更名，所以切记要验证。<br>　　并且没有严格规定必须三个组成部分必须是来自同一提供，可随性发挥。<br>　　且Homebrew在早期版本中更新源的是在/usr/local目录下的，而现在是在/usr/local/Homebrew，不过应该都是可以使用<code>&quot;$(brew --repo)&quot;</code>来自动指向目录的，所以无需理会。<br>　　如果你之前折腾过不少导致你的Homebrew有点问题，那么可以尝试使用如下方案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 诊断Homebrew的问题:</span></div><div class="line">$ brew doctor</div><div class="line"></div><div class="line"><span class="comment"># 重置brew.git设置:</span></div><div class="line">$ <span class="built_in">cd</span> <span class="string">"<span class="variable">$(brew --repo)</span>"</span></div><div class="line">$ git fetch</div><div class="line">$ git reset --hard origin/master</div><div class="line"></div><div class="line"><span class="comment"># homebrew-core.git同理:</span></div><div class="line">$ <span class="built_in">cd</span> <span class="string">"<span class="variable">$(brew --repo)</span>/Library/Taps/homebrew/homebrew-core"</span></div><div class="line">$ git fetch</div><div class="line">$ git reset --hard origin/master</div><div class="line"></div><div class="line"><span class="comment"># 应用生效:</span></div><div class="line">$ brew update</div></pre></td></tr></table></figure>
<h2 id="重置更新源"><a href="#重置更新源" class="headerlink" title="重置更新源"></a>重置更新源</h2><p>　　所谓有进则有退，在某些时候也有换回官方源的需求。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 重置brew.git:</span></div><div class="line">$ <span class="built_in">cd</span> <span class="string">"<span class="variable">$(brew --repo)</span>"</span></div><div class="line">$ git remote <span class="built_in">set</span>-url origin https://github.com/Homebrew/brew.git</div><div class="line"></div><div class="line"><span class="comment"># 重置homebrew-core.git:</span></div><div class="line">$ <span class="built_in">cd</span> <span class="string">"<span class="variable">$(brew --repo)</span>/Library/Taps/homebrew/homebrew-core"</span></div><div class="line">$ git remote <span class="built_in">set</span>-url origin https://github.com/Homebrew/homebrew-core.git</div></pre></td></tr></table></figure>
<p>　　至于homebrew-bottles，本质上作为一个环境变量的存在，之前的命令也只是将其写入到<code>/usr/.bash_profile</code>中，并且只是在文件尾部添加一行。所以之前的命令不推荐重复执行，在未掌握相关命令技巧的前提下，我推荐直接去修改<code>.bash_profile</code>文件：<img src="https://musoucrow.github.io/images/brew_changing/bash_profile.png" alt="bash_profile"><br>　　当然这里的主题是重置更新源，所以我们直接选择删除环境变量HOMEBREW_BOTTLE_DOMAIN，使其成为默认值即可。<br>　　当然，最后不要忘记<code>$ brew update</code>进行应用。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>　　在完成更新源的更换后，我们可以使用<code>$ brew upgrade</code>将现有的软件进行更新至最新版本，这样便能很直接的看出速度上的变化了。最后不要忘记<code>$ brew cleanup</code>将旧有的软件安装包进行清理。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Musoucrow" />
          <p class="site-author-name" itemprop="name">Musoucrow</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">53</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://coding.net/u/musoucrow" target="_blank" title="Coding">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Coding
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/MusouCrow" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Musoucrow</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"musoucrow"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="local-search-pop-overlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("yhjLFkD4PnRxISuvmJFRDE0w-gzGzoHsz", "Qw708UVatkDdMTPY8PtLty9O");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


  

</body>
</html>
